<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle Financeiro Mensal</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4;--success:#10b981}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial; margin:0;background:linear-gradient(180deg,#071022 0%, #071229 100%);color:#e6eef6;padding:24px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px 6px;text-align:left;font-size:14px}
    thead th{font-size:13px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.03)}
    tbody tr:hover{background:rgba(255,255,255,0.02)}
    .number{text-align:right}
    .muted{color:var(--muted);font-size:13px}
    button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#012;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.1)}
    .small{padding:6px 8px;font-size:13px}
    .summary{display:flex;flex-direction:column;gap:10px}
    .summary .row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,0.01),transparent)}
    .positive{color:var(--success);font-weight:700}
    .negative{color:#f04343;font-weight:700}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    canvas {margin-top:16px; background:#fff; border-radius:8px; padding:6px;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Controle Financeiro Mensal</h1>
      <div class="controls">
        <label class="muted">Mês</label>
        <select id="monthSelect"></select>
        <label class="muted">Ano</label>
        <select id="yearSelect"></select>
        <button id="saveBtn" class="small">Salvar</button>
        <button id="clearBtn" class="small ghost">Limpar Mês</button>
        <button id="pdfBtn" class="small">Exportar PDF</button>
      </div>
    </header>

    <div class="grid">
      <main class="card">
        <section>
          <h3>Despesas</h3>
          <button id="addExpense">+ Adicionar despesa</button>
          <table id="expensesTable">
            <thead><tr><th>Nome</th><th>Categoria</th><th class="number">Valor (R$)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section style="margin-top:14px">
          <h3>A Receber</h3>
          <button id="addReceive">+ Adicionar</button>
          <table id="receivesTable">
            <thead><tr><th>Fonte</th><th class="number">Valor (R$)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section style="margin-top:14px">
          <h3>Renda</h3>
          <button id="addIncome">+ Adicionar</button>
          <table id="incomeTable">
            <thead><tr><th>Fonte</th><th class="number">Valor (R$)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </section>
      </main>

      <aside class="card summary">
        <h3>Resumo — <span id="periodLabel"></span></h3>
        <div class="row"><div>Renda total</div><div id="totalIncome">R$ 0,00</div></div>
        <div class="row"><div>A receber</div><div id="totalReceive">R$ 0,00</div></div>
        <div class="row"><div>Despesas</div><div id="totalExpense">R$ 0,00</div></div>
        <div class="row" style="font-size:16px"><div>Saldo</div><div id="balance">R$ 0,00</div></div>

        <!-- Gráficos -->
        <canvas id="financeChart" height="200"></canvas>
        <canvas id="categoryChart" height="200"></canvas>
      </aside>
    </div>

    <footer>Arquivo local (localStorage). Você pode exportar/importar para backup externo.</footer>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const qs = s => document.querySelector(s);
    const expensesTable = qs("#expensesTable tbody");
    const receivesTable = qs("#receivesTable tbody");
    const incomeTable = qs("#incomeTable tbody");
    const totalExpense = qs("#totalExpense");
    const totalReceive = qs("#totalReceive");
    const totalIncome = qs("#totalIncome");
    const balanceEl = qs("#balance");
    const periodLabel = qs("#periodLabel");
    const monthSelect = qs("#monthSelect");
    const yearSelect = qs("#yearSelect");

    const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho",
                    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    let data = {expenses:[],receives:[],income:[]};

    // Preenche selects
    months.forEach((m,i)=>{ 
      let opt=document.createElement("option"); 
      opt.value=i; opt.textContent=m; 
      monthSelect.appendChild(opt);
    });
    const currentYear=new Date().getFullYear();
    for(let y=currentYear-2;y<=currentYear+2;y++){
      let opt=document.createElement("option");
      opt.value=y; opt.textContent=y;
      yearSelect.appendChild(opt);
    }
    monthSelect.value=new Date().getMonth();
    yearSelect.value=currentYear;

    function renderCurrency(v){ return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }

    function renderTables(){
      expensesTable.innerHTML="";
      data.expenses.forEach((e,i)=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${e.name}</td><td>${e.category}</td><td class="number">${renderCurrency(e.value)}</td>
          <td><button class="small ghost" onclick="deleteItem('expenses',${i})">x</button></td>`;
        expensesTable.appendChild(tr);
      });
      receivesTable.innerHTML="";
      data.receives.forEach((r,i)=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.name}</td><td class="number">${renderCurrency(r.value)}</td>
          <td><button class="small ghost" onclick="deleteItem('receives',${i})">x</button></td>`;
        receivesTable.appendChild(tr);
      });
      incomeTable.innerHTML="";
      data.income.forEach((inc,i)=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${inc.name}</td><td class="number">${renderCurrency(inc.value)}</td>
          <td><button class="small ghost" onclick="deleteItem('income',${i})">x</button></td>`;
        incomeTable.appendChild(tr);
      });
      updateTotals();
    }

    function deleteItem(type,index){
      data[type].splice(index,1);
      renderTables();
    }

    function updateTotals(){
      const sum=arr=>arr.reduce((s,i)=>s+Number(i.value||0),0);
      const e=sum(data.expenses);
      const r=sum(data.receives);
      const inc=sum(data.income);
      totalExpense.textContent=renderCurrency(e);
      totalReceive.textContent=renderCurrency(r);
      totalIncome.textContent=renderCurrency(inc);
      const balance=inc+r-e;
      balanceEl.textContent=renderCurrency(balance);
      balanceEl.className=balance>=0?'positive':'negative';
      renderChart(inc,r,e,balance);
      renderCategoryChart();
    }

    // gráfico geral
    let financeChart, categoryChart;
    function renderChart(inc,r,e,balance){
      const ctx=document.getElementById('financeChart').getContext('2d');
      if(financeChart) financeChart.destroy();
      financeChart=new Chart(ctx,{type:'doughnut',
        data:{labels:['Renda','A Receber','Despesas','Saldo'],
          datasets:[{data:[inc,r,e,balance],backgroundColor:['#10b981','#06b6d4','#f04343','#9aa4b2']}]},
        options:{plugins:{legend:{position:'bottom',labels:{color:'#000'}}}}
      });
    }
    function renderCategoryChart(){
      const ctx=document.getElementById('categoryChart').getContext('2d');
      if(categoryChart) categoryChart.destroy();
      const categorias={};
      data.expenses.forEach(e=>{categorias[e.category]=(categorias[e.category]||0)+Number(e.value||0);});
      categoryChart=new Chart(ctx,{type:'bar',
        data:{labels:Object.keys(categorias),
          datasets:[{label:'Despesas por Categoria (R$)',data:Object.values(categorias),backgroundColor:'#f04343'}]},
        options:{responsive:true,plugins:{legend:{labels:{color:'#000'}}},
          scales:{x:{ticks:{color:'#000'}},y:{ticks:{color:'#000'}}}}
      });
    }

    // Persistência
    function getKey(){ return `finance_${yearSelect.value}_${monthSelect.value}`; }
    function saveMonth(){ localStorage.setItem(getKey(),JSON.stringify(data)); }
    function loadMonth(){
      const key=getKey();
      data=JSON.parse(localStorage.getItem(key)||'{"expenses":[],"receives":[],"income":[]}');
      periodLabel.textContent=months[monthSelect.value]+"/"+yearSelect.value;
      renderTables();
    }

    // Eventos botões
    qs("#addExpense").addEventListener("click",()=>{
      const name=prompt("Nome da despesa:"); if(!name) return;
      const category=prompt("Categoria:")||"Outros";
      const value=parseFloat(prompt("Valor:").replace(",","."))||0;
      data.expenses.push({name,category,value});
      renderTables();
    });
    qs("#addReceive").addEventListener("click",()=>{
      const name=prompt("Fonte:"); if(!name) return;
      const value=parseFloat(prompt("Valor:").replace(",","."))||0;
      data.receives.push({name,value});
      renderTables();
    });
    qs("#addIncome").addEventListener("click",()=>{
      const name=prompt("Fonte:"); if(!name) return;
      const value=parseFloat(prompt("Valor:").replace(",","."))||0;
      data.income.push({name,value});
      renderTables();
    });
    qs("#saveBtn").addEventListener("click",()=>{ saveMonth(); alert("Dados salvos!"); });
    qs("#clearBtn").addEventListener("click",()=>{ if(confirm("Apagar dados do mês?")){ localStorage.removeItem(getKey()); loadMonth(); } });
    monthSelect.addEventListener("change",loadMonth);
    yearSelect.addEventListener("change",loadMonth);

    // PDF export já estava pronto
    qs('#pdfBtn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text(`Relatório Financeiro - ${months[monthSelect.value]}/${yearSelect.value}`, 10, y);
      y += 10;
      doc.addImage(document.getElementById('financeChart').toDataURL("image/png"), "PNG", 10, y, 90, 70);
      doc.addImage(document.getElementById('categoryChart').toDataURL("image/png"), "PNG", 110, y, 90, 70);
      y += 80;
      function addSection(title, items, headers) {
        doc.setFontSize(12); doc.text(title, 10, y); y += 6;
        doc.setFontSize(10); doc.text(headers.join(" | "), 10, y); y += 6;
        items.forEach(i => { doc.text(Object.values(i).join(" | "), 10, y); y += 6; }); y += 6;
      }
      addSection("Renda", data.income, ["Fonte","Valor"]);
      addSection("A Receber", data.receives, ["Fonte","Valor"]);
      addSection("Despesas", data.expenses, ["Nome","Categoria","Valor"]);
      doc.text(`Saldo: ${balanceEl.textContent}`, 10, y);
      doc.save(`Relatorio_Financeiro_${yearSelect.value}_${monthSelect.value}.pdf`);
    });

    loadMonth(); // inicialização
  </script>
</body>
</html>
